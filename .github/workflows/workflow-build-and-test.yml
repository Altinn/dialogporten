name: Build and test .NET

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: ./global.json

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        env:
          DialogportenSettings:Environment: "test"
          DialogportenSettings:Maskinporten:ClientId: ${{secrets.DIALOGPORTEN_MASKINPORTEN_CLIENTID}}
          DialogportenSettings:Maskinporten:Scope: ${{secrets.DIALOGPORTEN_MASKINPORTEN_SCOPE}}
          DialogportenSettings:Maskinporten:EncodedJwk: ${{secrets.DIALOGPORTEN_MASKINPORTEN_ENCODEDJWK}}
          Ed25519Keys:Primary:Kid: ${{secrets.ED25519KEYS_PRIMARY_KID}}
          Ed25519Keys:Primary:PublicComponent: ${{secrets.ED25519KEYS_PRIMARY_PUBLICCOMPONENT}}
        run: dotnet test --no-build --configuration Release
