# todo: What should be the SOC here? What shuold we configure in bicep vs this yaml template
properties:
  template:
    containers:
    - name: 'webapi-eu'
      # use input values
      image: ghcr.io/digdir/digdir/dialogporten-webapi:ee0bb79c2bb91f0290728cf8c962dc4910a43119
      env:
      # todo: use proper environment variables
      - name: ASPNETCORE_ENVIRONMENT
        value: 'Development'
      - name: 'APPLICATIONINSIGHTS_CONNECTION_STRING'
        value: 'appInsights.outputs.connectionString'
      - name: 'AZURE_APPCONFIG_URI'
        value: 'appConfiguration.outputs.endpoint'
      - name: 'ASPNETCORE_URLS'
        value: 'http://+:8080'
      - name: 'GIT_SHA'
        value: 'gitSha'
      probes:
      - type: Liveness
        periodSeconds: 5
        initialDelaySeconds: 2
        httpGet:
          path: '/healthz'
          port: 8080
      - type: 'Readiness'
        periodSeconds: 5
        initialDelaySeconds: 2
        httpGet:
          path: '/healthz'
          port: 8080
    initContainers:
      - name: 'migration-verifier-init'
        image: '${baseImageUrl}migration-verifier:${gitSha}'
        # todo: use proper environment variables
        env: 
          - name: 'AZURE_TENANT_ID'
            value: 'subscription().tenantId'
          - name: 'SUBSCRIPTION_ID'
            value: 'subscription().subscriptionId'
          - name: 'AZURE_CLIENT_ID'
            value: 'migrationVerifierPrincipalAppId'
          - name: 'AZURE_CLIENT_SECRET'
            value: 'migrationVerifierPrincipalPassword'
          - name: 'MIGRATION_JOB_NAME'
            value: 'migrationJob.name'
          - name: 'RESOURCE_GROUP_NAME'
            value: 'resourceGroup().name'
    scale:
      minReplicas: 1
      maxReplicas: 5
      rules:
      - name: httpscalingrule
        custom:
          type: http
          metadata:
            concurrentRequests: '50'
            