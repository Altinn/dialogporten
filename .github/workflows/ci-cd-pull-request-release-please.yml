name: CI/CD Pull Request Release Please

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - "tests/k6/**"

jobs:
  send-slack-message:
    runs-on: ubuntu-latest
    name: Send GitHub slack message
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Slackify markdown
      id: slackify
      uses: LoveToKnow/slackify-markdown-action@v1.1.1
      with:
        text: ${{ github.event.pull_request.body }}
    - name: Send GitHub slack message
      id: slack
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      uses: slackapi/slack-github-action@v1.27.0
      with:
        channel-id: 'C07A822MM7T'
        payload: |
          {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "plain_text",
                    "text": ":shipit: *${{ github.event.pull_request.title }}* :shipit: \n"
                  }
                },
                { "type": "divider" },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJson(steps.slackify.outputs.text) }}
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Approve Release"
                      },
                      "url": "https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/reviews"
                    }
                  ]
                }
              ]
          }
