{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.36.177.2456",
      "templateHash": "9434673033489522426"
    }
  },
  "definitions": {
    "ScaleRule": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string"
        },
        "custom": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "allowedValues": [
                "cpu",
                "memory"
              ]
            },
            "metadata": {
              "type": "object",
              "properties": {
                "type": {
                  "type": "string",
                  "allowedValues": [
                    "Utilization"
                  ]
                },
                "value": {
                  "type": "string"
                }
              }
            }
          }
        }
      },
      "metadata": {
        "__bicep_export!": true
      }
    },
    "Scale": {
      "type": "object",
      "properties": {
        "minReplicas": {
          "type": "int"
        },
        "maxReplicas": {
          "type": "int"
        },
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ScaleRule"
          }
        }
      },
      "metadata": {
        "__bicep_export!": true
      }
    },
    "Probes": {
      "type": "object",
      "properties": {
        "startup": {
          "type": "object",
          "properties": {
            "periodSeconds": {
              "type": "int"
            },
            "initialDelaySeconds": {
              "type": "int"
            },
            "successThreshold": {
              "type": "int"
            },
            "failureThreshold": {
              "type": "int"
            },
            "timeoutSeconds": {
              "type": "int"
            }
          }
        },
        "liveness": {
          "type": "object",
          "properties": {
            "periodSeconds": {
              "type": "int"
            },
            "initialDelaySeconds": {
              "type": "int"
            },
            "successThreshold": {
              "type": "int"
            },
            "failureThreshold": {
              "type": "int"
            },
            "timeoutSeconds": {
              "type": "int"
            }
          }
        },
        "readiness": {
          "type": "object",
          "properties": {
            "periodSeconds": {
              "type": "int"
            },
            "initialDelaySeconds": {
              "type": "int"
            },
            "successThreshold": {
              "type": "int"
            },
            "failureThreshold": {
              "type": "int"
            },
            "timeoutSeconds": {
              "type": "int"
            }
          }
        }
      },
      "metadata": {
        "__bicep_export!": true
      }
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "The location where the resources will be deployed"
      }
    },
    "envVariables": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "The environment variables for the container app"
      }
    },
    "port": {
      "type": "int",
      "defaultValue": 8080,
      "metadata": {
        "description": "The port on which the container app will run"
      }
    },
    "name": {
      "type": "string",
      "metadata": {
        "description": "The name of the container app"
      }
    },
    "image": {
      "type": "string",
      "metadata": {
        "description": "The image to be used for the container app"
      }
    },
    "whitelistedIPs": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "List of IP address ranges allowed to access the container app ingress (e.g. APIM public IPs)"
      }
    },
    "containerAppEnvId": {
      "type": "string",
      "metadata": {
        "description": "The ID of the container app environment"
      }
    },
    "tags": {
      "type": "object",
      "metadata": {
        "description": "The tags to be applied to the container app"
      }
    },
    "resources": {
      "type": "object",
      "nullable": true,
      "metadata": {
        "description": "CPU and memory resources for the container app"
      }
    },
    "revisionSuffix": {
      "type": "string",
      "metadata": {
        "description": "The suffix for the revision of the container app"
      }
    },
    "workloadProfileName": {
      "type": "string",
      "defaultValue": "Consumption",
      "metadata": {
        "description": "The workload profile to use for the container app"
      }
    },
    "scale": {
      "$ref": "#/definitions/Scale",
      "defaultValue": {
        "minReplicas": 1,
        "maxReplicas": 1,
        "rules": []
      },
      "metadata": {
        "description": "The scaling configuration for the container app"
      }
    },
    "probes": {
      "$ref": "#/definitions/Probes",
      "defaultValue": {
        "startup": {
          "periodSeconds": 10,
          "initialDelaySeconds": 10,
          "successThreshold": 1,
          "failureThreshold": 3,
          "timeoutSeconds": 2
        },
        "readiness": {
          "periodSeconds": 5,
          "initialDelaySeconds": 15,
          "successThreshold": 1,
          "failureThreshold": 3,
          "timeoutSeconds": 2
        },
        "liveness": {
          "periodSeconds": 5,
          "initialDelaySeconds": 20,
          "successThreshold": 1,
          "failureThreshold": 3,
          "timeoutSeconds": 2
        }
      },
      "metadata": {
        "description": "The health probe configuration for the container app"
      }
    },
    "userAssignedIdentityId": {
      "type": "string",
      "minLength": 1,
      "metadata": {
        "description": "The ID of the user-assigned managed identity"
      }
    }
  },
  "variables": {
    "copy": [
      {
        "name": "whitelistedIpSecurityRestrictions",
        "count": "[length(parameters('whitelistedIPs'))]",
        "input": {
          "name": "[format('whitelist-{0}', copyIndex('whitelistedIpSecurityRestrictions'))]",
          "action": "Allow",
          "ipAddressRange": "[parameters('whitelistedIPs')[copyIndex('whitelistedIpSecurityRestrictions')]]"
        }
      }
    ],
    "probeList": [
      {
        "periodSeconds": "[parameters('probes').startup.periodSeconds]",
        "initialDelaySeconds": "[parameters('probes').startup.initialDelaySeconds]",
        "successThreshold": "[parameters('probes').startup.successThreshold]",
        "failureThreshold": "[parameters('probes').startup.failureThreshold]",
        "timeoutSeconds": "[parameters('probes').startup.timeoutSeconds]",
        "type": "Startup",
        "httpGet": {
          "path": "/health/startup",
          "port": "[parameters('port')]"
        }
      },
      {
        "periodSeconds": "[parameters('probes').readiness.periodSeconds]",
        "initialDelaySeconds": "[parameters('probes').readiness.initialDelaySeconds]",
        "successThreshold": "[parameters('probes').readiness.successThreshold]",
        "failureThreshold": "[parameters('probes').readiness.failureThreshold]",
        "timeoutSeconds": "[parameters('probes').readiness.timeoutSeconds]",
        "type": "Readiness",
        "httpGet": {
          "path": "/health/readiness",
          "port": "[parameters('port')]"
        }
      },
      {
        "periodSeconds": "[parameters('probes').liveness.periodSeconds]",
        "initialDelaySeconds": "[parameters('probes').liveness.initialDelaySeconds]",
        "failureThreshold": "[parameters('probes').liveness.failureThreshold]",
        "successThreshold": "[parameters('probes').liveness.successThreshold]",
        "timeoutSeconds": "[parameters('probes').liveness.timeoutSeconds]",
        "type": "Liveness",
        "httpGet": {
          "path": "/health/liveness",
          "port": "[parameters('port')]"
        }
      }
    ],
    "cleanedRevisionSuffix": "[replace(parameters('revisionSuffix'), '.', '-')]",
    "ipSecurityRestrictions": "[if(empty(parameters('whitelistedIPs')), createArray(), variables('whitelistedIpSecurityRestrictions'))]",
    "ingress": {
      "targetPort": "[parameters('port')]",
      "external": true,
      "ipSecurityRestrictions": "[variables('ipSecurityRestrictions')]"
    }
  },
  "resources": {
    "managedIdentity": {
      "existing": true,
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2024-11-30",
      "name": "[last(split(parameters('userAssignedIdentityId'), '/'))]"
    },
    "containerApp": {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2024-03-01",
      "name": "[parameters('name')]",
      "location": "[parameters('location')]",
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[format('{0}', parameters('userAssignedIdentityId'))]": {}
        }
      },
      "properties": {
        "configuration": {
          "ingress": "[variables('ingress')]"
        },
        "environmentId": "[parameters('containerAppEnvId')]",
        "workloadProfileName": "[parameters('workloadProfileName')]",
        "template": {
          "revisionSuffix": "[variables('cleanedRevisionSuffix')]",
          "scale": "[parameters('scale')]",
          "containers": [
            {
              "name": "[parameters('name')]",
              "image": "[parameters('image')]",
              "env": "[parameters('envVariables')]",
              "probes": "[variables('probeList')]",
              "resources": "[parameters('resources')]"
            }
          ]
        }
      },
      "tags": "[parameters('tags')]"
    }
  },
  "outputs": {
    "identityPrincipalId": {
      "type": "string",
      "value": "[reference('managedIdentity').principalId]"
    },
    "name": {
      "type": "string",
      "value": "[parameters('name')]"
    },
    "revisionName": {
      "type": "string",
      "value": "[reference('containerApp').latestRevisionName]"
    }
  }
}