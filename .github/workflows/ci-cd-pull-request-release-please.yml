name: CI/CD Pull Request Release Please

on:
  pull_request:
    branches: [main]
    paths-ignore:
      - "tests/k6/**"

jobs:
  send-slack-message:
    runs-on: ubuntu-latest
    name: Send GitHub slack message
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      # todo
    # - name: Set PR body single line
    #   id: set_pr_body_single_line
    #   run: |
    #     PR_BODY=$(${{ github.event.pull_request.body }})
    #     echo "PR_BODY=${PR_BODY}" >> $GITHUB_OUTPUT
    - name: Send GitHub slack message
      id: slack
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      uses: slackapi/slack-github-action@v1.27.0
      with:
        channel-id: 'C07A822MM7T'
        # todo: replace with file-path
        payload-file-path: ".github/new-release-ready.json"
        payload: |
          {
              "text": "New Release Ready!\n",
              "blocks": [
                { "type": "divider" },
                {
                  "type": "section",
                  "text": {
                    "type": "plain_text",
                    "text": ":shipit: *${{ github.event.pull_request.title }}* :shipit: \n"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJson(github.event.pull_request.body) }}
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Approve Release"
                      },
                      "url": "https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/reviews"
                    }
                  ]
                }
              ]
          }
